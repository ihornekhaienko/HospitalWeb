function changeRating(n,t,i){try{ratingHubConnection.invoke("ChangeRating",n,t,i)}catch(r){console.log(r.message)}}function increment(){try{let n=document.getElementById("notifications-count"),t=n.textContent;t?n.textContent=+t+1:n.appendChild(document.createTextNode("1"))}catch(n){console.log(n.message)}}function decrement(){try{let n=document.getElementById("notifications-count"),t=n.textContent;n.textContent=+t==1?null:+t-1}catch(n){console.log(n.message)}}function removeNotification(n){try{let t=document.getElementById("notifications"),i=t.firstChild;i&&(t.removeChild(i),decrement());n.stopPropagation();n.preventDefault()}catch(t){console.log(t.message)}}function updatePopover(){try{const n=[].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));n.map(n=>{let t={animation:!1};n.hasAttribute("data-bs-content-id")&&(t.content=document.getElementById(n.getAttribute("data-bs-content-id")).innerHTML,t.html=!0);new bootstrap.Popover(n,t)})}catch(n){console.log(n.message)}}function updatePageLink(){let n=document.getElementsByClassName("pagination")[0];console.log(n);let t=n.children.length+1;if(console.log(n),console.log(t),!(t>2)){let u=document.URL.split("?")[0]+"?page="+t,i=document.createElement("a");i.classList.add("page-link");i.setAttribute("href",u);i.innerHTML=t;let r=document.createElement("li");r.classList.add("page-item");r.appendChild(i);n.classList.remove("d-none");n.appendChild(r)}}function createNotificationDiv(n,t,i="alert-info"){let r=document.createElement("div");r.classList.add("alert");r.classList.add(i);r.classList.add("p-1");r.classList.add("mb-1");let u=document.createElement("h6");u.classList.add("alert-heading");u.appendChild(document.createTextNode(n));r.appendChild(u);let f=document.createElement("p");return f.classList.add("m-0"),f.appendChild(document.createTextNode(t)),r.appendChild(f),r}function notifySignUp(n,t,i){try{notificationHubConnection.invoke("NotifySignUp",n,t,i)}catch(r){console.log(r.message)}}function getNotificationType(n){switch(n){case 0:return"alert-secondary";case 1:return"alert-danger";case 2:return"alert-success";case 3:return"alert-primary";default:return"alert-info"}}function loadLatest(){$.ajax({type:"POST",url:"/Home/LoadLatestNotifications",dataType:"json",contentType:"application/json",success:function(n){if(n!=null){let t=document.getElementById("notifications");t.innerHTML="";let i=document.getElementById("notifications-count");i.innerHTML="";for(let i of n){let n=getNotificationType(i.type),r=createNotificationDiv(i.topic,i.message,n);t.appendChild(r);increment()}updatePopover()}},error:function(n){console.log(n)}})}function notifyCancel(n,t,i){try{notificationHubConnection.invoke("NotifyCancel",n,t,i)}catch(r){console.log(r.message)}}function notifyFill(n,t,i){try{notificationHubConnection.invoke("NotifyFill",n,t,i)}catch(r){console.log(r.message)}}function notifyUserSendMessage(n,t){try{notificationHubConnection.invoke("NotifyUserSendMessage",n,t)}catch(i){console.log(i.message)}}function notifyAdminSendMessage(n,t){try{notificationHubConnection.invoke("NotifyAdminSendMessage",n,t)}catch(i){console.log(i.message)}}function read(n){try{$.ajax({url:"/Manage/ReadNotification",data:{id:n.toString()},contentType:"application/json",success:function(){let t=document.getElementById("alert-"+n);t.classList.remove("alert-success");t.classList.remove("alert-danger");t.classList.remove("alert-primary");t.classList.add("alert-secondary");loadLatest()},error:function(n){console.log(n.responseText)}})}catch(t){console.log(t.message)}}function confirmSignUp(n){return confirm(n)}function updateAppoitmentsStates(){$.ajax({url:"https://yigalhospitalapi.azurewebsites.net/jobs/updateStates",type:"POST",crossDomain:!0,headers:{accept:"application/json","Access-Control-Allow-Origin":"*"},success:function(){console.log("states update")},error:function(){console.log("states update failed")}})}function createIncomeMessage(n,t){let u=document.createElement("div");u.classList.add("income-date");u.appendChild(document.createTextNode(t.toLocaleString()));let i=document.createElement("div");i.classList.add("msg");i.appendChild(u);i.appendChild(document.createTextNode(n));let r=document.createElement("div");return r.classList.add("income-msg"),r.appendChild(i),r.classList.add("mb-1"),r}function createOutcomeMessage(n,t){let r=document.createElement("div");r.classList.add("out-date");r.appendChild(document.createTextNode(t.toLocaleString()));let i=document.createElement("div");i.classList.add("my-msg");i.appendChild(r);i.appendChild(document.createTextNode(n));let u=document.createElement("div");return u.classList.add("out-msg"),u.appendChild(i),u}function updateGuests(n,t,i,r,u){guestsMessages[n]?guestsMessages[n].push({text:i,messageType:r,dateTime:u}):(guestsMessages[n]=[{text:i,messageType:r,dateTime:u}],chats.push({userId:n,fullName:t,lastMessageDateTime:u,lastMessage:i}))}function createChat(n,t,i,r,u=false){let o=document.createElement("input");o.type="hidden";o.value=n;let s=document.createElement("h6");s.classList.add("card-title");s.appendChild(document.createTextNode(t));let h=document.createElement("p");h.classList.add("card-text","text-muted","text-sm","mb-0");h.appendChild(document.createTextNode(i.toLocaleString()));let c=document.createElement("p");c.classList.add("card-text");c.appendChild(document.createTextNode(r));let f=document.createElement("div");f.classList.add("card-body");f.appendChild(o);f.appendChild(s);f.appendChild(h);f.appendChild(c);let e=document.createElement("div");return e.classList.add("card","mb-1"),e.id=`chat-${n}`,e.appendChild(f),e.onclick=function(){u?openGuestChat(n,t):openChat(n,t)},e}function openGuestChat(n,t){let i=document.getElementById("chat-user");for(let t of guestsMessages[n])if(t.messageType==0){let n=createIncomeMessage(t.text,new Date(t.dateTime));i.appendChild(n)}else{let n=createOutcomeMessage(t.text,new Date(t.dateTime));i.appendChild(n)}document.getElementById("chat-list").classList.toggle("d-none");let r=document.getElementsByClassName("chat-user");for(let n of r)n.classList.toggle("d-none");$("#chat-user-id").val(n);$("#chat-user-name").val(t)}function openChat(n,t){let i=document.getElementById("chat-user");$.ajax({type:"POST",url:"/Chat/GetUserMessages",dataType:"json",contentType:"application/json",data:{userId:n},success:function(n){for(let t of n)if(t.messageType==0){let n=createIncomeMessage(t.text,new Date(t.dateTime));i.appendChild(n)}else{let n=createOutcomeMessage(t.text,new Date(t.dateTime));i.appendChild(n)}i.lastChild.scrollIntoView()},error:function(n){console.log(n)}});document.getElementById("chat-list").classList.toggle("d-none");let r=document.getElementsByClassName("chat-user");for(let n of r)n.classList.toggle("d-none");$("#chat-user-id").val(n);$("#chat-user-name").val(t)}function updateChats(n,t,i,r,u=false){$(`#chat-${n}`).length&&document.getElementById(`chat-${n}`).remove();let f=createChat(n,t,r,i,u);$("#chat-list").prepend(f)}function sendMessageToAdmins(n,t,i,r){try{supportHubConnection.invoke("SendMessageToAdmins",n,t,i,r.toISOString())}catch(u){console.log(u.message)}}function sendMessageToUser(n,t,i,r){try{supportHubConnection.invoke("SendMessageToUser",n,t,i,r.toISOString())}catch(u){console.log(u.message)}}function sendMessageFromUnauthorized(n,t){try{supportHubConnection.invoke("SendMessageFromUnauthorized",n,t.toISOString())}catch(i){console.log(i.message)}}function sendMessageToUnauthorized(n,t,i){try{supportHubConnection.invoke("SendMessageToUnauthorized",n,t,i.toISOString())}catch(r){console.log(r.message)}}var guestsMessages,chats;const ratingHubConnection=(new signalR.HubConnectionBuilder).withUrl("/RatingHub").build();ratingHubConnection.on("ChangeRating",function(n,t){try{let i=document.getElementById(`rating-overall-${t}`);i.innerHTML=n}catch(i){console.log(i.message)}});ratingHubConnection.start();const notificationHubConnection=(new signalR.HubConnectionBuilder).withUrl("/NotificationHub").build();notificationHubConnection.on("NotifySignUp",function(n,t){try{let r=document.getElementById("notifications");r.insertBefore(createNotificationDiv(n,t,"alert-primary"),r.firstChild);r.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink());let i=document.getElementById("notifications-profile");if(i){let r=document.createElement("div");r.classList.add("row");r.appendChild(createNotificationDiv(n,t,"alert-primary"));i.insertBefore(r,i.firstChild);i.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink())}increment();updatePopover()}catch(i){console.log(i.message)}});notificationHubConnection.on("NotifyCancel",function(n,t){try{let r=document.getElementById("notifications");r.insertBefore(createNotificationDiv(n,t,"alert-danger"),r.firstChild);r.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink());let i=document.getElementById("notifications-profile");if(i){let r=document.createElement("div");r.classList.add("row");r.appendChild(createNotificationDiv(n,t,"alert-danger"));i.insertBefore(r,i.firstChild);i.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink())}increment();updatePopover()}catch(i){console.log(i.message)}});notificationHubConnection.on("NotifyFill",function(n,t){try{let r=document.getElementById("notifications");r.insertBefore(createNotificationDiv(n,t,"alert-success"),r.firstChild);r.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink());let i=document.getElementById("notifications-profile");if(i){let r=document.createElement("div");r.classList.add("row");r.appendChild(createNotificationDiv(n,t,"alert-success"));i.insertBefore(r,i.firstChild);i.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink())}increment();updatePopover()}catch(i){console.log(i.message)}});notificationHubConnection.on("NotifyUserSendMessage",function(n,t){try{let r=document.getElementById("notifications");r.insertBefore(createNotificationDiv(n,t,"alert-primary"),r.firstChild);r.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink());let i=document.getElementById("notifications-profile");if(i){let r=document.createElement("div");r.classList.add("row");r.appendChild(createNotificationDiv(n,t,"alert-primary"));i.insertBefore(r,i.firstChild);i.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink())}increment();updatePopover()}catch(i){console.log(i.message)}});notificationHubConnection.on("NotifyAdminSendMessage",function(n,t){try{let r=document.getElementById("notifications");r.insertBefore(createNotificationDiv(n,t,"alert-primary"),r.firstChild);r.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink());let i=document.getElementById("notifications-profile");if(i){let r=document.createElement("div");r.classList.add("row");r.appendChild(createNotificationDiv(n,t,"alert-primary"));i.insertBefore(r,i.firstChild);i.children.length>5&&(i.removeChild(i.lastElementChild),updatePageLink())}increment();updatePopover()}catch(i){console.log(i.message)}});notificationHubConnection.start();$("#activator").click(function(){$("#uploader").click()});$("#uploader").change(function(){this.form.submit()});const supportHubConnection=(new signalR.HubConnectionBuilder).withUrl("/SupportHub").build(),chatListPopup=document.querySelector(".chatlist-popup"),chatPopup=document.querySelector(".chat-popup"),chatArea=document.querySelector(".chat-area");let chatBtn=$("#chat-btn");chatBtn.length&&chatBtn.click(function(){chatPopup.classList.toggle("show")});let allChatsBtn=$("#chat-all-users");allChatsBtn.length&&allChatsBtn.click(function(){document.getElementById("chat-list").classList.toggle("d-none");let n=document.getElementsByClassName("chat-user");for(let t of n)t.classList.toggle("d-none");let t=document.getElementById("chat-user");t.innerHTML="";$("#chat-user-id").val("");$("#chat-user-name").val("")});guestsMessages={};chats=[];$(document).ready(function(){let n=$("#chat-list");n.length&&$.ajax({type:"POST",url:"/Chat/GetChats",dataType:"json",contentType:"application/json",success:function(t){chats=t;for(let t of chats){let i=createChat(t.userId,t.fullName,new Date(t.lastMessageDateTime),t.lastMessage);n.append(i)}},error:function(n){console.log(n)}})});$(document).ready(function(){let n=$("#msg-list");n.length&&$.ajax({type:"POST",url:"/Chat/GetUserMessages",dataType:"json",contentType:"application/json",data:{userId:$("#chat-user-id").val()},success:function(t){for(let i of t)if(i.messageType==0){let t=createOutcomeMessage(i.text,new Date(i.dateTime));n.append(t)}else{let t=createIncomeMessage(i.text,new Date(i.dateTime));n.append(t)}n.children().last()[0].scrollIntoView()},error:function(n){console.log(n)}})});let userSend=$("#user-send");userSend.length&&userSend.click(function(){let r=$("#chat-user-id").val(),t=$("#chat-user-name").val(),n=$("#message-text").val().trim(),i=new Date;if(n.length!=0){let u=createOutcomeMessage(n,i);chatArea.insertAdjacentElement("beforeend",u);$("#message-text").val("");chatArea.lastChild.scrollIntoView();notifyUserSendMessage(t,n);sendMessageToAdmins(r,t,n,i)}});supportHubConnection.on("SendMessageToAdmins",function(n,t,i,r){try{if(r=new Date(r),$("#chat-user-id").val()==n){let n=createIncomeMessage(i,r);$("#chat-user").append(n);$("#chat-user").children().last()[0].scrollIntoView()}updateChats(n,t,i,r)}catch(u){console.log(u.message)}});let adminSend=$("#admin-send");adminSend.length&&adminSend.click(function(){let n=$("#chat-user-id").val(),r=$("#chat-user-name").val(),t=$("#message-text").val().trim(),i=new Date;t.length!=0&&($("#message-text").val(""),guestsMessages[n]?sendMessageToUnauthorized(n,t,i):(notifyAdminSendMessage(n,t),sendMessageToUser(n,r,t,i)))});supportHubConnection.on("SendMessageToUser",function(n,t,i,r){try{if(r=new Date(r),$("#chat-list").length){if($("#chat-user-id").val()==n){let n=createOutcomeMessage(i,r);$("#chat-user").append(n);$("#chat-user").children().last()[0].scrollIntoView()}updateChats(n,t,i,r)}else{let n=createIncomeMessage(i,r);$("#msg-list").append(n)}}catch(u){console.log(u.message)}});let guestSend=$("#guest-send");guestSend.length&&guestSend.click(function(){let n=$("#message-text").val().trim(),t=new Date;if(n.length!=0){let i=createOutcomeMessage(n,t);chatArea.insertAdjacentElement("beforeend",i);$("#message-text").val("");chatArea.lastChild.scrollIntoView();notifyUserSendMessage("Unauthorized user",n);sendMessageFromUnauthorized(n,t)}});supportHubConnection.on("SendMessageFromUnauthorized",function(n,t,i){try{if(i=new Date(i),$("#chat-user-id").val()==n){let n=createIncomeMessage(t,i);$("#chat-user").append(n);$("#chat-user").children().last()[0].scrollIntoView()}let r=`Unauthorized (${n})`;updateGuests(n,r,t,0,i);updateChats(n,r,t,i,!0)}catch(r){console.log(r.message)}});supportHubConnection.on("SendMessageToUnauthorized",function(n,t,i){try{if(i=new Date(i),$("#chat-list").length){if($("#chat-user-id").val()==n){let n=createOutcomeMessage(t,i);$("#chat-user").append(n);$("#chat-user").children().last()[0].scrollIntoView()}let r=`Unauthorized (${n})`;updateGuests(n,r,t,0,i);updateChats(n,r,t,i,!0)}else{let n=createIncomeMessage(t,i);$("#msg-list").append(n)}}catch(r){console.log(r.message)}});supportHubConnection.start();